# ===============================================================
# ARCHIVO PRINCIPAL DE CONFIGURACIÓN DE NGINX
# Este archivo reemplaza completamente /etc/nginx/nginx.conf
# ===============================================================

# ===============================================================
# Habla directamente con el navegador, entrega archivos estaticos
# y envia peticiiones diinamcas a Gunicorn (Django)
# ===============================================================

# ---------- PROCESOS DE TRABAJO ----------
# Número de procesos worker que Nginx crea.
# 1 suele ser suficiente para contenedores Docker.
worker_processes 1;


# ---------- BLOQUE EVENTS ----------
events {
    # Máximo de conexiones simultáneas que puede manejar cada worker.
    worker_connections 1024;
}


# ---------- BLOQUE HTTP PRINCIPAL ----------
http {
    # Activa el uso de sendfile(), un método eficiente para enviar archivos.
    # Recomendado para servir archivos estáticos.
    sendfile on;

    # Tipos MIME para que Nginx sepa qué tipo de contenido está sirviendo
    # (CSS, JS, imágenes, etc.)
    include /etc/nginx/mime.types;

    # Tipo por defecto si no coincide con nada de los mime.types
    default_type application/octet-stream;



    # =======================================================
    # UPSTREAM → Grupo de servidores backend (Gunicorn Django)
    # =======================================================
    # Este bloque define el backend donde se enviarán las
    # peticiones. En Docker, puedes acceder al contenedor "web"
    # por su nombre de servicio, puerto 8000 (Gunicorn).
    upstream django {
        server web:8000;
    }



    # =======================================================
    # SERVIDOR PRINCIPAL
    # =======================================================
    server {
        # Nginx escucha en el puerto 80 DENTRO del contenedor.
        # Como en docker-compose tienes "8080:80",
        # accedes por http://localhost:8080 en el host.
        listen 80;

        # Acepta cualquier servidor/host.
        server_name _;



        # ---------------- ARCHIVOS ESTÁTICOS ----------------
        # Todo lo que empiece por /static/ se sirve desde el
        # sistema de archivos y NO pasa por Django.
        location /static/ {
            # "alias" transforma la URL a un path real del contenedor.
            alias /code/static_root/;
        }



        # ---------------- PROXY A DJANGO ----------------
        # Todo lo demás ("/") se envía al backend Django/Gunicorn.
        location / {
            # Envía la solicitud al upstream "django"
            proxy_pass http://django;

            # Pasa el host original (dominio) para que Django
            # genere URLs correctas.
            proxy_set_header Host $host;

            # Pone la IP REAL del cliente (no la de nginx)
            proxy_set_header X-Real-IP $remote_addr;

            # Cadena de IPs por donde pasó la petición
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Indica al backend si vino por HTTP o HTTPS
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
